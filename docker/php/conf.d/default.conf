server {
    listen 80;
    server_name localhost;

    # Đặt thư mục gốc là /app/public. Đây là phần quan trọng nhất.
    # Nginx sẽ tìm các file tĩnh (CSS, JS, images) trong thư mục này.
    root /app/public;

    # Các file mặc định khi truy cập một thư mục.
    index index.php index.html;

    # Xử lý tất cả các request.
    location / {
        # Lệnh try_files là chìa khóa:
        # 1. Nginx sẽ cố gắng tìm một file khớp với URI (ví dụ: /css/app.css).
        # 2. Nếu không thấy, nó sẽ tìm một thư mục khớp với URI (ví dụ: /images/).
        # 3. Nếu cả hai đều không tồn tại, nó sẽ chuyển request đến ứng dụng Swoole
        #    thông qua /index.php (để router của bạn xử lý).
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Khi một request được chuyển đến /index.php, nó sẽ được proxy đến service 'app'.
    location = /index.php {
        # Proxy đến server Swoole đang chạy trong container 'app' ở cổng 9501.
        proxy_pass http://app:9501;

        # Các header cần thiết để ứng dụng PHP nhận đúng thông tin từ client.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_read_timeout 600s; # Tăng timeout cho các tác vụ chạy lâu
    }

    # Chặn truy cập vào các file ẩn (ví dụ: .htaccess, .git).
    location ~ /\. {
        deny all;
    }
}