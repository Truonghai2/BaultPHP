# Upstream cho server ứng dụng PHP (Swoole)
upstream php_app {
    # 'app' là tên service trong file docker-compose.yml
    server app:9501;
}

# Upstream cho server Vite dev
upstream vite_server {
    # 'vite' là tên service trong file docker-compose.yml
    server vite:5173;
}

# Sử dụng map để quyết định upstream cho các request WebSocket HMR đến root.
# Nếu là request WebSocket, trỏ đến vite_server, nếu không thì trỏ đến php_app.
map $http_upgrade $proxy_upstream {
    default php_app;
    websocket vite_server;
}

# Sử dụng map để xử lý giá trị cho header Connection.
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name localhost;
    # Thư mục root này quan trọng để Nginx có thể phục vụ các file tĩnh (nếu có)
    root /app/public;
    index index.php;

    # Log files
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Location này sẽ bắt các request dành cho Vite và HMR.
    # Nó phải được đặt TRƯỚC location / chính.
    # Nó khớp với các đường dẫn như /@vite/..., /resources/..., /src/...
    location ~ ^/(@vite|node_modules|resources|src) {
        # Proxy request tới server Vite
        proxy_pass http://vite_server;

        # Các header bắt buộc để kết nối WebSocket (HMR) hoạt động
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400; # Giữ kết nối mở
    }

    # Xử lý tất cả các request khác bằng cách chuyển đến ứng dụng PHP
    location / {
        # Sử dụng biến đã được map để chọn upstream động.
        # Điều này cho phép các request WebSocket (HMR) đến root được chuyển đến Vite,
        # trong khi các request thông thường được chuyển đến ứng dụng PHP.
        proxy_pass http://$proxy_upstream;

        # Các header chung cho cả hai upstream.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Các header cần thiết cho WebSocket, sẽ được xử lý đúng đắn bởi map.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 86400;
    }
}